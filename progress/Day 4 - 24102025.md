# Day 4 - 24/10/2025

## Scostamenti dal piano
- **Minimo ritardo accettato**: l’integrazione Keycloak era prevista tra Giorno 3-4, ma è stata posticipata per completare prima l’enforcement RLS end-to-end e i relativi test.

## Attività svolte
- Introdotte nuove migrazioni SQL per attivare la Row-Level Security su `accounts`, `transactions`, `otp_audits` e `security_logs`, con policy basate su `app.current_user_id`.
- Aggiornato il `decision-log` (sezione Sicurezza) per tracciare formalmente la scelta di abilitare RLS sulle tabelle multi-tenant.
- Esteso il layer database FastAPI (`backend/app/db.py`) con l’helper `set_current_user_id` e la dipendenza `get_connection_with_rls` che imposta automaticamente l’ID utente su ogni connessione del pool.
- Aggiornati gli endpoint `/accounts` e `/transactions` per usare la nuova dipendenza, così ogni query/inserimento rispetta le policy RLS senza filtri manuali.
- Aggiunto un test d’integrazione (`test_list_transactions_respects_rls`) che crea un utente secondario e verifica che le transazioni siano visibili solo passando il relativo `X-User-Id`.
- Applicate tutte le nuove migrazioni tramite `python -m backend.db.manage migrate` e verificate localmente.
- Eseguita l’intera suite `pytest` (accounts + transactions) dopo l’avvio dei container `postgres` e `backend`, con esito positivo e senza regressioni.
- Dockerizzato il backend FastAPI con Dockerfile dedicato e servizio `backend` in `infra/docker-compose.yml`, garantendo parità di ambiente con Postgres.
- Aggiornate le istruzioni operative (README e `.env`) per distinguere i parametri DB tra host e container.
- Raccolti i prerequisiti per l’integrazione Keycloak/OIDC (servizio nel compose, realm `thesis`, variabili OIDC) da applicare nel prossimo sprint.
- Aggiunte le dipendenze Authlib/python-jose, la configurazione `Settings` e il nuovo `.env.example` con i parametri OIDC di default.

## Attività in sospeso
- Completare il microservizio OTP (email reali + SMS simulati) e collegarlo con il backend.
- Ampliare la suite di test a casi di errore/validazione e predisporre la pipeline CI su GitHub Actions.
- Preparare ed eseguire la sessione di collaudo end-to-end di sabato (`docs/test-plan-saturday.md`).

## Aggiornamenti successivi (02/11/2025)
- Microservizio OTP completato: servizio FastAPI dedicato (email reali + SMS simulati) e integrazione con backend `/otp/send` e audit su `otp_audits`.
- Avviato il container Keycloak con import automatico del realm `thesis`, definendo client scope `thesis-access`, attributo utente `user_id` e mapper per scope/audience.
- Abilitata la validazione OIDC lato backend (`OIDC_ENABLED=true`) con audience `backend`, sostituito l'header `X-User-Id` con token Bearer e sincronizzata la configurazione nel README.
- Documentata la procedura per ottenere un access token (`frontend` password grant) e invocare le API con `Authorization: Bearer` in modo coerente con le policy RLS.
